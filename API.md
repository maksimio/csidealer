# Главное

API сервера сделано по следующему принципу: При ошибке возвращается:

```json
{ "success": false, "message": "Сообщение об ошибке" }
```

При успешном запросе возвращается:

```json
{ "success": true, "result": { "...": "..." } }
```

В некоторых ответах поле _result_ отсутствует.

# 1. Последние значения CSI

## Запрос

```http
GET /api/v1/csi/last?n=12&type=abs&id=303966ef-ea7a-46d3-975d-af9006cb8247&round=6&smooth=8
```

| Параметр | Тип | Описание |
| :-- | :-- | :-- |
| `n` | `number` | Число последних пакетов. Если пакетов меньше, чем n, будут возвращены все пакеты. |
| `type` | `string` | Тип данных в массиве data: `abs`, `phase`, `re` или `im` |
| `id` | `string` | **Опционально.** Идентификатор пакета, который принимается за конечный. Пригодится для запроса `abs` и `phase` для одной и той же группы пакетов. По умолчанию передается последний пакет csi |
| `round` | `number` | **Опционально.** Число знаков после запятой. Сильно влияет на размер пакета. По умолчанию равно 3 |
| `smooth` | `number` | **Опционально.** Размер скользящего окна для сглаживания по оси времени. По умолчанию равно 1 |

## Ответ

```json
{
  "success": true,
  "result": [
    // Пакеты возвращаются в правильном хронологическом порядке
    {
      "timestamp": 1674676924296,
      "id": "303966ef-ea7a-46d3-975d-af9006cb8247",
      "n": 44, // Порядковый номер пакета после старта сервера
      "info": {
        "ts": 375548752,
        "csilen": 560,
        "txchan": 2462,
        "err": 0,
        "noise": 0,
        "rate": 143,
        "bwidth": 0,
        "ntones": 56,
        "nr": 2,
        "nc": 2,
        "rssi0": 76,
        "rssi1": 73,
        "rssi2": 73,
        "rssi3": 128,
        "payloadlen": 1056
      },
      "data": [
        // размерность nr x nc x n_tones
        [-123, -134, -139, "..."],
        [40, 46, 53, "..."],
        [-126, -137, -130, "..."],
        [43, 49, 56, "..."]
      ]
    },
    "..."
  ]
}
```

# 2. Управление записью CSI в файл в сыром виде

## Запрос

```http
PATCH /api/v1/log/:action?filepath="./server/logs"
```

| Параметр | Тип | Описание |
| :-- | :-- | :-- |
| `:action` | `string` | Включить / остановить запись: `start`, `stop` |
| `filepath` | `string` | Только для `start`. Относительный путь к файлу записи. В него начнут сохраняться следующие принятые пакеты. |

## Ответ

```json
{ "success": true }
```

# 3. Информация о записи CSI в файл

## Запрос

```http
GET /api/v1/log/status
```

_нет параметров_

## Ответ

```json
{
  "success": true,
  "result": {
    "start_timestamp": 12341234134,
    "is_open": true,
    "write_byte_count": 13244352,
    "package_count": 2312
  }
}
```

# 4. Управление фильтрацией

## Запрос

```http
PATCH /api/v1/filter/:action?payloadLenMin=300&payloadLenMax=550&nr=2&nc=2&nTones=56
```

| Параметр | Тип | Описание |
| :-- | :-- | :-- |
| `:action` | `string` | Включить / выключить фильтрацию: `start`, `stop` |
| `payloadLenMin` | `number` | **Опционально.** Только для `start`. Минимальная длина полезной нагрузки. |
| `payloadLenMax` | `number` | **Опционально.** Только для `start`. Максимальная длина полезной нагрузки. Позволяет отфильтровать пакеты, принятые от других устройств. Мы задаем конкретный payloadlen у Tx, что позволяет использовать несколько Tx с одним Rx и различать их |
| `nr` | `number` | **Опционально.** Только для `start`. Число антенн Rx, например 2 |
| `nc` | `number` | **Опционально.** Только для `start`. Число антенн Tx, например 2 |
| `nTones` | `number` | **Опционально.** Только для `start`. Число поднесущих, например 56 |

## Ответ

```json
{ "success": true }
```

# 5. Информация о фильтрации

## Запрос

```http
GET /api/v1/log/status
```

_нет параметров_

## Ответ

```json
{
  "success": true,
  "result": {
    "start_timestamp": 12341234134,
    "is_filtering": true,
    "nr": 2,
    "nc": 2,
    "nTones": 56,
    "payloadlen": { "min": 300, "max": 550 }
  }
}
```

# 6. Информация об устройствах

## Запрос

```http
GET /api/v1/devices/list
```

_нет параметров_

## Ответ

```json
{
  "success": true,
  "result": [
    {
      "id": "303966ef-975d-af9006cb8247-ea7a-46d3",
      "host": "192.168.1.201",
      "mode_client": false, // прием и ретрансляция CSI
      "mode_send": false, // отправка CSI
      "available": true, // доступно ли подключение (ping)
      "connection": true, // было ли подключение
      "conn_timestamp": 45342523452 // время подключения
    },
    { "...": "..." }
  ]
}
```

# 7. <Подключиться к | Отключиться от> роутера

## Запрос

```http
PATCH /api/v1/devices/<connect | disconnect>/:id
```

| Параметр | Тип      | Описание              |
| :------- | :------- | :-------------------- |
| `:id`    | `string` | Идентификатор роутера |

### Пример:

```http
PATCH /api/v1/devices/disconnect/303966ef-975d-af9006cb8247-ea7a-46d3
```

## Ответ

```json
{ "success": true }
```

# 8. <Начать | остановить> <отправку | прием> данных на роутере

## Запрос

```http
PATCH /api/v1/<send | receive>/<start | stop>/:id
```

| Параметр | Тип      | Описание              |
| :------- | :------- | :-------------------- |
| `:id`    | `string` | Идентификатор роутера |

### Пример:

```http
PATCH /api/v1/send/start/303966ef-975d-af9006cb8247-ea7a-46d3
```

## Ответ

```json
{ "success": true }
```

# 9. Создать сущность роутера

## Запрос

```http
POST /api/v1/router?host=192.168.1.202
```

| Параметр | Тип      | Описание                          |
| :------- | :------- | :-------------------------------- |
| `host`   | `string` | IP-адрес роутера в локальной сети |

## Ответ

```json
{
  "success": true,
  "result": {
    "id": "303966ef-975d-af9006cb8247-ea7a-46d3"
  }
}
```

# 10. Удалить сущность роутера

## Запрос

```http
DELETE /api/v1/router/:id
```

| Параметр | Тип      | Описание              |
| :------- | :------- | :-------------------- |
| `:id`    | `string` | Идентификатор роутера |

## Ответ

```json
{ "success": true }
```

# WebSocket

## Приходят данные

```json
{
  "success": true,
  "result": [
    // Пакеты возвращаются в правильном хронологическом порядке
    {
      "timestamp": 1674676924296,
      "id": "303966ef-ea7a-46d3-975d-af9006cb8247",
      "n": 44, // Порядковый номер пакета после старта сервера
      "info": {
        "ts": 375548752,
        "csilen": 560,
        "txchan": 2462,
        "err": 0,
        "noise": 0,
        "rate": 143,
        "bwidth": 0,
        "ntones": 56,
        "nr": 2,
        "nc": 2,
        "rssi0": 76,
        "rssi1": 73,
        "rssi2": 73,
        "rssi3": 128,
        "payloadlen": 1056
      },
      "data": [
        // размерность nr x nc x n_tones
        [-123, -134, -139, "..."],
        [40, 46, 53, "..."],
        [-126, -137, -130, "..."],
        [43, 49, 56, "..."]
      ]
    },
    "..."
  ]
}
```
